{% extends 'base.html' %}
{% block title %}Clasificacion de Data | Data Intel{% endblock %}
{% block page_name %}Clasificacion{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header">
  <h1>Clasificacion de Data</h1>
  <p>Organiza tus menciones automaticamente definiendo categorias y tematicas con palabras clave.</p>
</div>

<!-- PASO 1: CARGA DE ARCHIVO -->
<div class="card" style="margin-bottom: 24px;">
  <div class="card-title"><i class="fa-solid fa-file-csv"></i> 1. Seleccionar Archivo</div>
  <div class="upload-zone" id="drop-zone" onclick="document.getElementById('csv_file').click()">
    <i class="fa-solid fa-cloud-arrow-up"></i>
    <div class="upload-zone-title">Haz clic o arrastra el archivo CSV</div>
    <div class="upload-zone-hint" id="file-name-display">No se ha seleccionado ningun archivo (UTF-16 Tabulado recomendado)</div>
    <input type="file" id="csv_file" accept=".csv" style="display: none;" />
  </div>
</div>

<!-- PASO 2: REGLAS -->
<div class="card" id="settings-card" style="margin-bottom: 24px;">
  <div class="card-title"><i class="fa-solid fa-sliders"></i> 2. Configuracion y Reglas</div>

  <div class="form-row" style="margin-bottom: 20px;">
    <div class="form-group">
      <label class="form-label" for="default_val">Etiqueta para filas no clasificadas</label>
      <input type="text" id="default_val" class="form-input" placeholder="Sin Clasificar" value="Sin Clasificar">
    </div>

    <div class="form-group" style="background: var(--c-accent-light); padding: 16px; border-radius: var(--r-md); border: 1px solid #ffeeba;">
      <label class="form-check" style="font-weight: 600; color: #856404;">
        <input type="checkbox" id="use_keywords">
        Doble Pasada (Columna 'Keywords')
      </label>
      <p class="form-hint" style="color: #856404; margin-top: 6px;">
        <strong>Nota:</strong> Mas preciso al capturar menciones sin texto en 'Hit Sentence', pero puede aumentar el tiempo.
      </p>
    </div>
  </div>

  <p class="form-hint" style="margin-bottom: 20px;">
    Las menciones se buscaran primero en <strong>'Hit Sentence'</strong> y opcionalmente en <strong>'Keywords'</strong>.
  </p>

  <div id="rules-container"></div>

  <button type="button" class="btn-add" onclick="addCategory()" style="margin-top: 12px;">
    <i class="fa-solid fa-plus"></i> Anadir Nueva Categoria
  </button>
</div>

<!-- PASO 3: RESULTADOS -->
<div class="card animate-fade" id="results-card" style="display: none; margin-bottom: 24px;">
  <div class="card-title"><i class="fa-solid fa-chart-pie"></i> Insights y Resultados</div>

  <div id="insights-text" class="flash-msg info" style="margin-bottom: 24px;"></div>

  <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 24px; margin-bottom: 24px;">
    <div style="background: var(--c-bg); padding: 16px; border-radius: var(--r-lg); border: 1px solid var(--c-border-light);">
      <canvas id="distChart"></canvas>
    </div>
    <div id="results-summary"></div>
  </div>

  <div id="results-tree" style="background: var(--c-bg); padding: 20px; border-radius: var(--r-lg); border: 1px solid var(--c-border-light); max-height: 400px; overflow-y: auto;"></div>

  <div style="margin-top: 24px; display: flex; gap: 12px;">
    <button class="btn btn-secondary" onclick="resetForm()">
      <i class="fa-solid fa-arrow-left"></i> Volver a ajustar
    </button>
    <a id="download-link" href="#" class="btn btn-primary" style="flex-grow: 1; text-align: center;">
      <i class="fa-solid fa-download"></i> Descargar Archivo Clasificado
    </a>
  </div>
</div>

<!-- ACCION FINAL -->
<div id="action-bar-container" style="text-align: center; margin-top: 32px;">
  <div class="classifier-actions">
    <div>
      <span style="color: var(--c-text-secondary); font-size: 0.88rem;">Listo para procesar:</span>
      <strong style="color: var(--c-primary);" id="status-text">Definir reglas y subir archivo</strong>
    </div>
    <div style="width: 1px; height: 20px; background: var(--c-border);"></div>
    <button id="btnProcess" onclick="processClassification()" class="btn btn-primary">
      <i class="fa-solid fa-bolt"></i> Clasificar Datos
    </button>
  </div>
</div>

<script>
    let myChart = null;
    let categories = [
        {
            id: Date.now(),
            name: "Economia",
            tematicas: [
                { id: Date.now() + 1, name: "Inflacion", keywords: "precios, costo, canasta" }
            ]
        }
    ];

    const container = document.getElementById('rules-container');
    const fileInput = document.getElementById('csv_file');
    const dropZone = document.getElementById('drop-zone');
    const fileNameDisplay = document.getElementById('file-name-display');

    // File handling
    fileInput.onchange = (e) => {
        if (e.target.files.length > 0) {
            fileNameDisplay.innerText = e.target.files[0].name;
            document.getElementById('status-text').innerText = "Archivo listo";
            dropZone.style.borderColor = 'var(--c-primary)';
        }
    };

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileNameDisplay.innerText = e.dataTransfer.files[0].name;
            document.getElementById('status-text').innerText = "Archivo listo";
        }
    });

    function renderRules() {
        container.innerHTML = '';
        categories.forEach((cat, catIdx) => {
            const catDiv = document.createElement('div');
            catDiv.className = 'rule-category animate-fade';
            catDiv.innerHTML = `
                <div class="category-header">
                    <input type="text" class="form-input" style="border:none; background:transparent; font-size:1.05rem; font-weight:600; padding:4px 8px; width:60%;"
                           value="${cat.name}" onchange="updateCategoryName(${catIdx}, this.value)" onfocus="this.style.background='var(--c-white)';this.style.border='1px solid var(--c-border)'" onblur="this.style.background='transparent';this.style.border='none'">
                    <button class="btn-remove" onclick="removeCategory(${catIdx})">
                        <i class="fa-solid fa-trash"></i> Eliminar
                    </button>
                </div>
                <div id="tematicas-${catIdx}">
                    ${cat.tematicas.map((tem, temIdx) => `
                        <div class="tematica-group animate-fade">
                            <div class="tematica-header">
                                <input type="text" class="form-input" placeholder="Tematica"
                                       style="font-weight:600; width: 40%; padding: 6px 10px;"
                                       value="${tem.name}" onchange="updateTematicaName(${catIdx}, ${temIdx}, this.value)">
                                <button class="btn-remove" onclick="removeTematica(${catIdx}, ${temIdx})">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <input type="text" class="form-input"
                                   placeholder="Palabras clave (separadas por comas)"
                                   style="font-size: 0.85rem;"
                                   value="${tem.keywords}" onchange="updateKeywords(${catIdx}, ${temIdx}, this.value)">
                        </div>
                    `).join('')}
                </div>
                <button type="button" class="btn-add" onclick="addTematica(${catIdx})" style="margin-top: 8px;">
                    <i class="fa-solid fa-plus"></i> Anadir Tematica
                </button>
            `;
            container.appendChild(catDiv);
        });
    }

    function addCategory() { categories.push({ id: Date.now(), name: "Nueva Categoria", tematicas: [{ id: Date.now() + 1, name: "Nueva Tematica", keywords: "" }] }); renderRules(); }
    function removeCategory(idx) { categories.splice(idx, 1); renderRules(); }
    function updateCategoryName(idx, val) { categories[idx].name = val; }
    function addTematica(catIdx) { categories[catIdx].tematicas.push({ id: Date.now(), name: "Nueva Tematica", keywords: "" }); renderRules(); }
    function removeTematica(catIdx, temIdx) { categories[catIdx].tematicas.splice(temIdx, 1); renderRules(); }
    function updateTematicaName(catIdx, temIdx, val) { categories[catIdx].tematicas[temIdx].name = val; }
    function updateKeywords(catIdx, temIdx, val) { categories[catIdx].tematicas[temIdx].keywords = val; }

    function resetForm() {
        document.getElementById('settings-card').style.display = 'block';
        document.getElementById('action-bar-container').style.display = 'block';
        document.getElementById('results-card').style.display = 'none';
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnProcess').innerHTML = '<i class="fa-solid fa-bolt"></i> Clasificar Datos';
        document.getElementById('status-text').innerText = "Ajusta las reglas";
        if (myChart) { myChart.destroy(); myChart = null; }
    }

    async function processClassification() {
        const btn = document.getElementById('btnProcess');
        const file = fileInput.files[0];
        const defaultVal = document.getElementById('default_val').value || "Sin Clasificar";
        const useKeywords = document.getElementById('use_keywords').checked;

        if (!file) { alert("Por favor, selecciona un archivo CSV primero."); return; }
        if (categories.length === 0) { alert("Define al menos una categoria y tematica."); return; }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
            document.getElementById('status-text').innerText = "Limpiando y clasificando...";

            const rulesPayload = categories.map(cat => ({
                category: cat.name,
                tematicas: cat.tematicas.map(tem => ({
                    name: tem.name,
                    keywords: tem.keywords.split(',').map(k => k.trim()).filter(k => k)
                }))
            }));

            const formData = new FormData();
            formData.append('csv_file', file);
            formData.append('rules', JSON.stringify(rulesPayload));
            formData.append('default_val', defaultVal);
            formData.append('use_keywords', useKeywords);

            const response = await fetch('/clasificacion', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) { showResults(result); }
            else { throw new Error(result.error || "Error desconocido"); }
        } catch (error) {
            console.error(error);
            alert("Error: " + error.message);
            btn.innerHTML = '<i class="fa-solid fa-bolt"></i> Reintentar';
            btn.disabled = false;
        }
    }

    function showResults(result) {
        console.log('[DEBUG] showResults called with:', result);
        
        if (!result || !result.stats) { 
            console.error('[DEBUG] Missing result or stats');
            alert("Error: El servidor no devolvio las estadisticas."); 
            resetForm(); 
            return; 
        }

        console.log('[DEBUG] Hiding settings and action bar...');
        document.getElementById('settings-card').style.display = 'none';
        document.getElementById('action-bar-container').style.display = 'none';
        
        console.log('[DEBUG] Showing results card...');
        const resultsCard = document.getElementById('results-card');
        console.log('[DEBUG] results-card element:', resultsCard);
        resultsCard.style.display = 'block';

        console.log('[DEBUG] Querying child elements...');
        let summary = document.getElementById('results-summary');
        let insightsDiv = document.getElementById('insights-text');
        
        console.log('[DEBUG] Initial query results:', { 
            summary: summary, 
            insightsDiv: insightsDiv,
            summaryExists: !!summary,
            insightsDivExists: !!insightsDiv
        });
        
        if (!summary || !insightsDiv) {
            console.error("[DEBUG] Missing expected results elements:", { summary, insightsDiv });
            console.log('[DEBUG] Attempting recovery...');
            
            // Fallback for missing elements
            const card = document.getElementById('results-card');
            if (card) {
                 // Try to recover if somehow they were deleted from DOM
                 if (!summary) {
                     console.log('[DEBUG] Creating summary element...');
                     const gridContainer = card.querySelector('div[style*="display: grid"]');
                     console.log('[DEBUG] Grid container found:', gridContainer);
                     if (gridContainer) {
                         let s = document.createElement('div');
                         s.id = 'results-summary';
                         gridContainer.appendChild(s);
                         summary = s; // Update the reference
                         console.log('[DEBUG] Summary created and appended');
                     }
                 }
                 if (!insightsDiv) {
                     console.log('[DEBUG] Creating insights element...');
                     let i = document.createElement('div');
                     i.id = 'insights-text';
                     i.className = 'flash-msg info';
                     i.style.marginBottom = '24px';
                     card.insertBefore(i, card.firstChild.nextSibling);
                     insightsDiv = i; // Update the reference
                     console.log('[DEBUG] Insights created and inserted');
                 }
            }
            
            // Re-query to ensure we have the elements
            console.log('[DEBUG] Re-querying elements...');
            if (!summary) summary = document.getElementById('results-summary');
            if (!insightsDiv) insightsDiv = document.getElementById('insights-text');
            
            console.log('[DEBUG] After recovery:', { 
                summary: summary, 
                insightsDiv: insightsDiv,
                summaryExists: !!summary,
                insightsDivExists: !!insightsDiv
            });
            
            // If still null, abort with error
            if (!summary || !insightsDiv) {
                console.error('[DEBUG] FATAL: Elements still null after recovery!');
                alert('Error: No se pudieron cargar los elementos de resultados. Por favor, recarga la pagina.');
                resetForm();
                return;
            }
        }
        
        console.log('[DEBUG] Elements verified, proceeding with data population...');
        
        const defaultVal = document.getElementById('default_val').value || "Sin Clasificar";

        const statsForDefault = result.stats[defaultVal] || { total: 0 };
        const unclassifiedCount = statsForDefault.total || 0;
        const totalRows = result.total_rows || 0;
        const classifiedCount = totalRows - unclassifiedCount;
        const percent = totalRows > 0 ? ((classifiedCount / totalRows) * 100).toFixed(1) : 0;

        let insightMsg = "";
        if (result.insights && result.insights.top_category != "N/A") {
            insightMsg = `<strong>Insights:</strong> La categoria mas impactante es <strong>"${result.insights.top_category}"</strong> con ${result.insights.top_count} menciones. `;
        } else {
            insightMsg = `<strong>Resumen:</strong> No se han detectado categorias predominantes fuera del valor por defecto. `;
        }
        insightMsg += `Se ha logrado clasificar el <strong>${percent}%</strong> del total de datos.`;
        insightsDiv.innerHTML = `<i class="fa-solid fa-lightbulb"></i> ${insightMsg}`;
        summary.innerHTML = `
            <div style="background: var(--c-primary-light); padding: 20px; border-radius: var(--r-lg); height: 100%;">
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 2.2rem; font-weight: 700; color: var(--c-primary); line-height:1;">${percent}%</div>
                    <div style="font-size: 0.82rem; color: var(--c-text-secondary);">Tasa de Clasificacion</div>
                </div>
                <div style="font-size: 0.92rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Analizado:</span> <strong>${totalRows}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--c-success);">
                        <span>Clasificados:</span> <strong>${classifiedCount}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: var(--c-danger);">
                        <span>Sin Clasificar:</span> <strong>${unclassifiedCount}</strong>
                    </div>
                </div>
            </div>
        `;

        renderChart(result.stats, defaultVal);

        const tree = document.getElementById('results-tree');
        if (tree) tree.innerHTML = "<h4 style='margin-bottom: 16px; border-bottom: 2px solid var(--c-primary); display: inline-block; padding-bottom: 4px;'>Desglose por Categoria</h4>";

        const sortedCats = Object.keys(result.stats).sort((a, b) => {
            if (a === defaultVal) return 1;
            if (b === defaultVal) return -1;
            return a.localeCompare(b);
        });

        sortedCats.forEach(catName => {
            const data = result.stats[catName];
            if (!data || !tree) return;
            const catNode = document.createElement('div');
            catNode.style.marginBottom = "12px";
            catNode.innerHTML = `
                <div style="display: flex; justify-content: space-between; font-weight: 600; background: var(--c-white); padding: 10px 14px; border-radius: var(--r-md); border: 1px solid var(--c-border-light);">
                    <span><i class="fa-solid fa-folder-open" style="color: var(--c-accent); margin-right: 8px;"></i> ${catName}</span>
                    <span class="badge badge-primary">${data.total || 0}</span>
                </div>
                <div style="padding-left: 20px; margin-top: 4px;">
                    ${data.tematicas ? Object.entries(data.tematicas).sort((a,b) => b[1]-a[1]).map(([tem, count]) => `
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; padding: 5px 10px; border-bottom: 1px dashed var(--c-border-light);">
                            <span style="color: var(--c-text-secondary);">&#x2022; ${tem}</span>
                            <span style="font-weight: 600;">${count}</span>
                        </div>
                    `).join('') : ''}
                </div>
            `;
            tree.appendChild(catNode);
        });

        document.getElementById('download-link').href = result.download_url;
    }

    function renderChart(stats, defaultVal) {
        const ctx = document.getElementById('distChart').getContext('2d');
        const labels = Object.keys(stats).filter(k => k !== defaultVal);
        const data = labels.map(l => stats[l].total);

        if (stats[defaultVal]) { labels.push("Otras"); data.push(stats[defaultVal].total); }

        const colors = ['#3f3fff', '#22c55e', '#f59e0b', '#a855f7', '#ffdd00', '#ef4444', '#14b8a6', '#334155', '#ea580c', '#94a3b8'];

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11, family: 'Inter' } } },
                    title: { display: true, text: 'Distribucion por Categorias', font: { size: 13, weight: '600', family: 'Inter' } }
                },
                cutout: '70%'
            }
        });
    }

    renderRules();
</script>

<style>
    #results-tree::-webkit-scrollbar { width: 6px; }
    #results-tree::-webkit-scrollbar-track { background: var(--c-bg); }
    #results-tree::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 10px; }
    #results-tree::-webkit-scrollbar-thumb:hover { background: var(--c-primary); }

    @media (max-width: 768px) {
      #results-card div[style*="grid-template-columns: 1fr 1.5fr"] {
        grid-template-columns: 1fr !important;
      }
    }
</style>
{% endblock %}
