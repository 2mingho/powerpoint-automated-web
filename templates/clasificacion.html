{% extends 'base.html' %}
{% block title %}Clasificaci√≥n de Data | Data Intel{% endblock %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<!-- Chart.js Integration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="classifier-dashboard">
    <div style="margin-bottom: 30px;">
        <h1 class="page-title">Clasificaci√≥n de Data</h1>
        <p style="color: #666;">Organiza tus menciones autom√°ticamente definiendo categor√≠as y tem√°ticas con palabras clave.</p>
    </div>

    <!-- PASO 1: CARGA DE ARCHIVO -->
    <div class="card" style="margin-bottom: 30px;">
        <div class="card-title">1. Seleccionar Archivo</div>
        <div class="upload-box" id="drop-zone" style="cursor: pointer;">
            <div class="upload-icon">üìÅ</div>
            <div>
                <strong>Haz clic o arrastra el archivo CSV</strong>
                <p id="file-name-display">No se ha seleccionado ning√∫n archivo (UTF-16 Tabulado recomendado)</p>
            </div>
            <input type="file" id="csv_file" accept=".csv" style="display: none;" />
        </div>
    </div>

    <!-- PASO 2: REGLAS -->
    <div class="card" id="settings-card">
        <div class="card-title">2. Configuraci√≥n y Reglas</div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <!-- Valor por Defecto -->
            <div class="form-group">
                <label for="default_val">Etiqueta para filas no clasificadas</label>
                <input type="text" id="default_val" placeholder="Sin Clasificar" value="Sin Clasificar" 
                       style="margin-top: 5px; width: 100%;">
            </div>

            <!-- Toggle B√∫squeda Secundaria -->
            <div class="form-group" style="background: #fff8e6; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba;">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #856404;">
                    <input type="checkbox" id="use_keywords" style="margin-right: 10px; width: 18px; height: 18px;">
                    Doble Pasada (Columna 'Keywords')
                </label>
                <p style="font-size: 0.8rem; color: #856404; margin-top: 5px; line-height: 1.2;">
                    <strong>Disclaimer:</strong> M√°s preciso al capturar menciones sin texto en 'Hit Sentence', pero puede aumentar el tiempo de procesamiento.
                </p>
            </div>
        </div>

        <p style="font-size: 0.85rem; color: #777; margin-bottom: 20px;">
            Las menciones se buscar√°n primero en <strong>'Hit Sentence'</strong> y luego opcionalmente en <strong>'Keywords'</strong>.
        </p>

        <div id="rules-container">
            <!-- Las categor√≠as se insertar√°n aqu√≠ din√°micamente -->
        </div>

        <button type="button" class="btn-add" onclick="addCategory()" style="width: 100%; padding: 12px; border-style: solid;">
            <i class="fa-solid fa-plus"></i> A√±adir Nueva Categor√≠a
        </button>
    </div>

    <!-- PASO 3: RESULTADOS -->
    <div class="card animate-fade" id="results-card" style="display: none;">
        <div class="card-title">2. Insights y Resultados</div>
        
        <div class="insights-summary" id="insights-text" style="background: #f0f7ff; border-left: 4px solid #3f3fff; padding: 15px; margin-bottom: 25px; border-radius: 4px; font-size: 0.95rem;">
            <!-- Insights generated here -->
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; margin-bottom: 30px;">
            <!-- Gr√°fico -->
            <div style="background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee;">
                <canvas id="distChart"></canvas>
            </div>
            
            <!-- Resumen num√©rico -->
            <div id="results-summary">
                <!-- Stats will be here -->
            </div>
        </div>
        
        <div id="results-tree" style="background: #f9f9f9; padding: 20px; border-radius: 12px; border: 1px solid #eee; max-height: 400px; overflow-y: auto;">
            <!-- Tree will be here -->
        </div>

        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button class="btn" onclick="resetForm()" style="background: #f0f0f0; color: #333;">
                <i class="fa-solid fa-arrow-left"></i> Volver a ajustar
            </button>
            <a id="download-link" href="#" class="btn" style="flex-grow: 1; text-align: center; background: #3f3fff; color: white;">
                <i class="fa-solid fa-download"></i> Descargar Archivo Clasificado
            </a>
        </div>
    </div>

    <!-- ACCI√ìN FINAL -->
    <div id="action-bar-container" style="text-align: center; margin-top: 40px;">
        <div class="classifier-actions">
            <div>
                <span style="color:#777; font-size: 0.9rem;">Listo para procesar:</span>
                <strong style="color:#3f3fff;" id="status-text">Definir reglas y subir archivo</strong>
            </div>
            <div style="width: 1px; height: 20px; background: #ddd;"></div>
            <button id="btnProcess" onclick="processClassification()" class="btn" style="margin:0;">
                <i class="fa-solid fa-bolt"></i> Clasificar Datos
            </button>
        </div>
    </div>
</div>

<script>
    let myChart = null;
    let categories = [
        {
            id: Date.now(),
            name: "Econom√≠a",
            tematicas: [
                { id: Date.now() + 1, name: "Inflaci√≥n", keywords: "precios, costo, canasta" }
            ]
        }
    ];

    const container = document.getElementById('rules-container');
    const fileInput = document.getElementById('csv_file');
    const dropZone = document.getElementById('drop-zone');
    const fileNameDisplay = document.getElementById('file-name-display');

    // Manejo de Archivos
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        if (e.target.files.length > 0) {
            fileNameDisplay.innerText = e.target.files[0].name;
            document.getElementById('status-text').innerText = "Archivo listo";
        }
    };

    // Renderizado de Reglas
    function renderRules() {
        container.innerHTML = '';
        categories.forEach((cat, catIdx) => {
            const catDiv = document.createElement('div');
            catDiv.className = 'rule-category animate-fade';
            catDiv.innerHTML = `
                <div class="category-header">
                    <input type="text" class="category-title editable" style="border:none; padding:5px; width:60%; font-size: 1.1rem;" 
                           value="${cat.name}" onchange="updateCategoryName(${catIdx}, this.value)">
                    <button class="btn-remove" onclick="removeCategory(${catIdx})">
                        <i class="fa-solid fa-trash"></i> Eliminar
                    </button>
                </div>
                <div id="tematicas-${catIdx}">
                    ${cat.tematicas.map((tem, temIdx) => `
                        <div class="tematica-group animate-fade">
                            <div class="tematica-header">
                                <input type="text" placeholder="Tem√°tica" 
                                       style="font-weight:bold; width: 40%;" 
                                       value="${tem.name}" onchange="updateTematicaName(${catIdx}, ${temIdx}, this.value)">
                                <button class="btn-remove" onclick="removeTematica(${catIdx}, ${temIdx})">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <input type="text" class="keywords-input" 
                                   placeholder="Palabras clave (separadas por comas)" 
                                   value="${tem.keywords}" onchange="updateKeywords(${catIdx}, ${temIdx}, this.value)">
                        </div>
                    `).join('')}
                </div>
                <button type="button" class="btn-add" onclick="addTematica(${catIdx})">
                    <i class="fa-solid fa-plus"></i> A√±adir Tem√°tica
                </button>
            `;
            container.appendChild(catDiv);
        });
    }

    function addCategory() {
        categories.push({
            id: Date.now(),
            name: "Nueva Categor√≠a",
            tematicas: [{ id: Date.now() + 1, name: "Nueva Tem√°tica", keywords: "" }]
        });
        renderRules();
    }

    function removeCategory(idx) {
        categories.splice(idx, 1);
        renderRules();
    }

    function updateCategoryName(idx, val) {
        categories[idx].name = val;
    }

    function addTematica(catIdx) {
        categories[catIdx].tematicas.push({ id: Date.now(), name: "Nueva Tem√°tica", keywords: "" });
        renderRules();
    }

    function removeTematica(catIdx, temIdx) {
        categories[catIdx].tematicas.splice(temIdx, 1);
        renderRules();
    }

    function updateTematicaName(catIdx, temIdx, val) {
        categories[catIdx].tematicas[temIdx].name = val;
    }

    function updateKeywords(catIdx, temIdx, val) {
        categories[catIdx].tematicas[temIdx].keywords = val;
    }

    function resetForm() {
        document.getElementById('settings-card').style.display = 'block';
        document.getElementById('action-bar-container').style.display = 'block';
        document.getElementById('results-card').style.display = 'none';
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnProcess').innerHTML = '<i class="fa-solid fa-bolt"></i> Clasificar Datos';
        document.getElementById('status-text').innerText = "Ajusta las reglas";
        if (myChart) {
            myChart.destroy();
            myChart = null;
        }
    }

    async function processClassification() {
        const btn = document.getElementById('btnProcess');
        const file = fileInput.files[0];
        const defaultVal = document.getElementById('default_val').value || "Sin Clasificar";
        const useKeywords = document.getElementById('use_keywords').checked;
        
        if (!file) {
            alert("Por favor, selecciona un archivo CSV primero.");
            return;
        }

        if (categories.length === 0) {
            alert("Define al menos una categor√≠a y tem√°tica.");
            return;
        }

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
            document.getElementById('status-text').innerText = "Limpiando y clasificando...";

            const rulesPayload = categories.map(cat => ({
                category: cat.name,
                tematicas: cat.tematicas.map(tem => ({
                    name: tem.name,
                    keywords: tem.keywords.split(',').map(k => k.trim()).filter(k => k)
                }))
            }));

            const formData = new FormData();
            formData.append('csv_file', file);
            formData.append('rules', JSON.stringify(rulesPayload));
            formData.append('default_val', defaultVal);
            formData.append('use_keywords', useKeywords);

            const response = await fetch('/clasificacion', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showResults(result);
            } else {
                throw new Error(result.error || "Error desconocido");
            }

        } catch (error) {
            console.error(error);
            alert("Error: " + error.message);
            btn.innerHTML = '<i class="fa-solid fa-bolt"></i> Reintentar';
            btn.disabled = false;
        }
    }

    function showResults(result) {
        console.log("Classification Result:", result);
        
        if (!result || !result.stats) {
            console.error("Missing stats in result", result);
            alert("Error: El servidor no devolvi√≥ las estad√≠sticas de clasificaci√≥n.");
            resetForm();
            return;
        }

        document.getElementById('settings-card').style.display = 'none';
        document.getElementById('action-bar-container').style.display = 'none';
        document.getElementById('results-card').style.display = 'block';

        const summary = document.getElementById('results-summary');
        const insightsDiv = document.getElementById('insights-text');
        const defaultVal = document.getElementById('default_val').value || "Sin Clasificar";
        
        const statsKeys = Object.keys(result.stats);
        const statsForDefault = result.stats[defaultVal] || { total: 0 };
        const unclassifiedCount = statsForDefault.total || 0;
        const totalRows = result.total_rows || 0;
        const classifiedCount = totalRows - unclassifiedCount;
        const percent = totalRows > 0 ? ((classifiedCount / totalRows) * 100).toFixed(1) : 0;

        // Generate Insight text
        let insightMsg = "";
        if (result.insights && result.insights.top_category != "N/A") {
            insightMsg = `<strong>Insights:</strong> La categor√≠a m√°s impactante es <strong>"${result.insights.top_category}"</strong> con ${result.insights.top_count} menciones clasificados. `;
        } else {
            insightMsg = `<strong>Resumen:</strong> No se han detectado categor√≠as predominantes fuera del valor por defecto. `;
        }
        insightMsg += `Se ha logrado clasificar el <strong>${percent}%</strong> del total de datos analizados.`;
        insightsDiv.innerHTML = `<i class="fa-solid fa-lightbulb"></i> ${insightMsg}`;

        summary.innerHTML = `
            <div style="background: #f5f7ff; padding: 20px; border-radius: 12px; height: 100%;">
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 2.2rem; font-weight: bold; color: #3f3fff; line-height:1;">${percent}%</div>
                    <div style="font-size: 0.85rem; color: #777;">Tasa de Clasificaci√≥n</div>
                </div>
                <div style="font-size: 0.95rem; color: #444;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Total Analizado:</span> <strong>${totalRows}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2ecc71;">
                        <span>Clasificados:</span> <strong>${classifiedCount}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; color: #e74c3c;">
                        <span>Sin Clasificar:</span> <strong>${unclassifiedCount}</strong>
                    </div>
                </div>
            </div>
        `;

        // Render Chart
        renderChart(result.stats, defaultVal);

        // Render Tree
        const tree = document.getElementById('results-tree');
        tree.innerHTML = "<h4 style='margin-bottom: 15px; border-bottom: 2px solid #3f3fff; display: inline-block;'>Desglose por Categor√≠a</h4>";
        
        const sortedCats = Object.keys(result.stats).sort((a, b) => {
            if (a === defaultVal) return 1;
            if (b === defaultVal) return -1;
            return a.localeCompare(b);
        });

        sortedCats.forEach(catName => {
            const data = result.stats[catName];
            if (!data) return;
            
            const catNode = document.createElement('div');
            catNode.style.marginBottom = "15px";
            catNode.innerHTML = `
                <div style="display: flex; justify-content: space-between; font-weight: bold; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <span><i class="fa-solid fa-folder-open" style="color: #ffdd00; margin-right: 8px;"></i> ${catName}</span>
                    <span style="background: #3f3fff; color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem;">${data.total || 0}</span>
                </div>
                <div style="padding-left: 20px; margin-top: 5px;">
                    ${data.tematicas ? Object.entries(data.tematicas).sort((a,b) => b[1]-a[1]).map(([tem, count]) => `
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; padding: 5px 10px; border-bottom: 1px dashed #eee;">
                            <span style="color: #666;">‚Ä¢ ${tem}</span>
                            <span style="font-weight: 600; color: #333;">${count}</span>
                        </div>
                    `).join('') : ''}
                </div>
            `;
            tree.appendChild(catNode);
        });

        const dlLink = document.getElementById('download-link');
        dlLink.href = result.download_url;
    }

    function renderChart(stats, defaultVal) {
        const ctx = document.getElementById('distChart').getContext('2d');
        const labels = Object.keys(stats).filter(k => k !== defaultVal);
        const data = labels.map(l => stats[l].total);
        
        // Add others/unclassified if any
        if (stats[defaultVal]) {
            labels.push("Otras");
            data.push(stats[defaultVal].total);
        }

        const colors = [
            '#3f3fff', '#2ecc71', '#e67e22', '#9b59b6', '#f1c40f', 
            '#e74c3c', '#1abc9c', '#34495e', '#d35400', '#7f8c8d'
        ];

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, font: { size: 10 } }
                    },
                    title: {
                        display: true,
                        text: 'Distribuci√≥n por Categor√≠as',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                cutout: '70%'
            }
        });
    }

    renderRules();
</script>

<style>
    .rule-category input[type="text"] {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        transition: all 0.2s;
        padding: 5px;
        margin-bottom: 0;
    }
    .rule-category input[type="text"]:focus, .rule-category input[type="text"]:hover {
        background: #fff;
        border-color: #ddd;
        outline: none;
    }
    .tematica-group input.keywords-input {
        background: #fff;
        border: 1px solid #eee;
        font-size: 0.9rem;
    }
    #results-tree::-webkit-scrollbar { width: 6px; }
    #results-tree::-webkit-scrollbar-track { background: #f1f1f1; }
    #results-tree::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    #results-tree::-webkit-scrollbar-thumb:hover { background: #3f3fff; }
</style>
{% endblock %}
