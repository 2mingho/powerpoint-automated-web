{% extends 'base.html' %}
{% block title %}Analisis Rapido CSV | Data Intel{% endblock %}
{% block page_name %}Analisis Rapido{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header">
  <h1>Analisis Rapido CSV</h1>
  <p>Carga cualquier archivo CSV y obten estadisticas completas en segundos.</p>
</div>

<!-- PASO 1: CONFIGURACION Y CARGA -->
<div class="card" id="upload-card" style="margin-bottom: 24px;">
    <div class="card-title"><i class="fa-solid fa-gear"></i> 1. Configuracion y Archivo</div>

    <div class="form-row" style="margin-bottom: 20px;">
        <div class="form-group">
            <label class="form-label" for="encoding">Codificacion</label>
            <select id="encoding" class="form-select">
                <option value="utf-8">UTF-8</option>
                <option value="utf-16">UTF-16</option>
                <option value="latin-1">Latin-1</option>
                <option value="cp1252">CP1252 (Windows)</option>
                <option value="iso-8859-1">ISO-8859-1</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" for="separator">Separador</label>
            <select id="separator" class="form-select">
                <option value=",">Coma (,)</option>
                <option value="\t">Tabulacion (Tab)</option>
                <option value=";">Punto y coma (;)</option>
                <option value="|">Barra vertical (|)</option>
            </select>
        </div>
    </div>

    <div class="upload-zone" id="drop-zone" onclick="document.getElementById('csv_file').click()">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <div class="upload-zone-title">Haz clic o arrastra el archivo CSV</div>
        <div class="upload-zone-hint" id="file-name-display">No se ha seleccionado ningun archivo</div>
        <input type="file" id="csv_file" accept=".csv" style="display: none;" />
    </div>

    <button id="btnAnalyze" onclick="analyzeFile()" class="btn btn-primary btn-block btn-lg" style="margin-top: 20px;">
        <i class="fa-solid fa-bolt"></i> Analizar Archivo
    </button>
</div>

<!-- PASO 2: RESULTADOS -->
<div id="results-section" style="display: none;">
    <!-- KPI Cards -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-title">
            <i class="fa-solid fa-chart-line"></i> Resumen General
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Metricas basicas: numero de filas, columnas, uso de memoria y porcentaje global de datos faltantes.</span>
            </div>
        </div>
        <div class="kpi-grid" id="kpi-cards"></div>
    </div>

    <!-- Data Types Chart -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-title">
            <i class="fa-solid fa-shapes"></i> Tipos de Datos
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Representacion visual de como se clasifican las columnas (Numeros, Texto o Fechas).</span>
            </div>
        </div>
        <div style="max-width: 400px; margin: 0 auto;">
            <canvas id="typesChart"></canvas>
        </div>
    </div>

    <!-- Missing Values Chart -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-title">
            <i class="fa-solid fa-chart-bar"></i> Valores Faltantes por Columna
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Identifica que columnas tienen huecos. Un alto porcentaje puede indicar datos incompletos.</span>
            </div>
        </div>
        <div id="missing-chart-container">
            <canvas id="missingChart"></canvas>
        </div>
    </div>

    <!-- Numeric Stats Table -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-title">
            <i class="fa-solid fa-calculator"></i> Estadisticas Numericas
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Medidas de tendencia central y dispersion.</span>
            </div>
        </div>
        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
            <table class="stats-table" id="numeric-stats-table"></table>
        </div>
    </div>

    <!-- Correlation Matrix -->
    <div class="card" style="margin-bottom: 24px;" id="correlation-card">
        <div class="card-title">
            <i class="fa-solid fa-diagram-project"></i> Matriz de Correlacion
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Muestra la relacion entre variables numericas. Valores cercanos a 1 o -1 indican una relacion fuerte.</span>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="stats-table correlation-table" id="correlation-table"></table>
        </div>
    </div>

    <!-- Distributions -->
    <div class="card" style="margin-bottom: 24px;" id="distributions-card">
        <div class="card-title">
            <i class="fa-solid fa-chart-area"></i> Distribuciones Numericas
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Histogramas que muestran como se reparten los valores.</span>
            </div>
        </div>
        <div class="chart-grid" id="distributions-container"></div>
    </div>

    <!-- Categorical Distributions -->
    <div class="card" style="margin-bottom: 24px;" id="categorical-card">
        <div class="card-title">
            <i class="fa-solid fa-list-check"></i> Distribuciones Categoricas (Top 10)
            <div class="tooltip">
                <i class="fa-solid fa-circle-info"></i>
                <span class="tooltip-text">Frecuencia de los valores mas comunes en columnas de texto.</span>
            </div>
        </div>
        <div class="chart-grid" id="categorical-container"></div>
    </div>

    <!-- Actions -->
    <div style="text-align: center; margin-top: 24px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <button onclick="resetForm()" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Analizar Otro Archivo
        </button>
        <a id="download-link" href="#" class="btn btn-primary">
            <i class="fa-solid fa-download"></i> Descargar Resumen CSV
        </a>
    </div>
</div>

<script>
let charts = {};

const fileInput = document.getElementById('csv_file');
const dropZone = document.getElementById('drop-zone');
const fileNameDisplay = document.getElementById('file-name-display');

// File upload handling
fileInput.onchange = (e) => {
    if (e.target.files.length > 0) {
        fileNameDisplay.innerText = e.target.files[0].name;
        dropZone.style.borderColor = 'var(--c-primary)';
    }
};

dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        fileNameDisplay.innerText = e.dataTransfer.files[0].name;
    }
});

async function analyzeFile() {
    const file = fileInput.files[0];
    const encoding = document.getElementById('encoding').value;
    const separator = document.getElementById('separator').value;
    const btn = document.getElementById('btnAnalyze');

    if (!file) { alert('Selecciona un archivo CSV primero.'); return; }

    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analizando...';

        const formData = new FormData();
        formData.append('csv_file', file);
        formData.append('encoding', encoding);
        formData.append('separator', separator);

        const response = await fetch('/analisis-csv', { method: 'POST', body: formData });
        const result = await response.json();

        if (result.success) { displayResults(result); }
        else { throw new Error(result.error || 'Error desconocido'); }
    } catch (error) {
        console.error(error);
        alert('Error: ' + error.message);
        btn.innerHTML = '<i class="fa-solid fa-bolt"></i> Reintentar';
        btn.disabled = false;
    }
}

function displayResults(data) {
    document.getElementById('upload-card').style.display = 'none';
    document.getElementById('results-section').style.display = 'block';

    const kpiContainer = document.getElementById('kpi-cards');
    kpiContainer.innerHTML = `
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fa-solid fa-table-cells"></i></div>
            <div class="kpi-value">${data.general.row_count.toLocaleString()}</div>
            <div class="kpi-label">Filas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fa-solid fa-table-columns"></i></div>
            <div class="kpi-value">${data.general.column_count}</div>
            <div class="kpi-label">Columnas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fa-solid fa-hard-drive"></i></div>
            <div class="kpi-value">${data.general.memory_usage_mb} MB</div>
            <div class="kpi-label">Memoria</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fa-solid fa-circle-exclamation" style="color:var(--c-danger)"></i></div>
            <div class="kpi-value">${data.missing.total_missing_percentage}%</div>
            <div class="kpi-label">Valores Faltantes</div>
        </div>
    `;

    renderTypesChart(data.general);
    renderMissingChart(data.missing);
    renderNumericStatsTable(data.numeric);

    if (data.correlation.matrix && data.correlation.matrix.length > 0) {
        renderCorrelationMatrix(data.correlation);
        document.getElementById('correlation-card').style.display = 'block';
    } else {
        document.getElementById('correlation-card').style.display = 'none';
    }

    if (data.distributions.numeric && data.distributions.numeric.length > 0) {
        renderDistributions(data.distributions.numeric);
        document.getElementById('distributions-card').style.display = 'block';
    } else {
        document.getElementById('distributions-card').style.display = 'none';
    }

    if (data.distributions.categorical && data.distributions.categorical.length > 0) {
        renderCategoricalDistributions(data.distributions.categorical);
        document.getElementById('categorical-card').style.display = 'block';
    } else {
        document.getElementById('categorical-card').style.display = 'none';
    }

    document.getElementById('download-link').href = data.download_url;
}

function renderTypesChart(general) {
    const ctx = document.getElementById('typesChart').getContext('2d');
    if (charts.types) charts.types.destroy();
    charts.types = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Numerico', 'Categorico', 'Fecha/Hora'],
            datasets: [{
                data: [general.numeric_columns.length, general.categorical_columns.length, general.datetime_columns.length],
                backgroundColor: ['#3f3fff', '#22c55e', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom', labels: { font: { family: 'Inter' } } },
                title: { display: true, text: 'Distribucion de Tipos de Columnas', font: { family: 'Inter', weight: '600' } }
            }
        }
    });
}

function renderMissingChart(missing) {
    const ctx = document.getElementById('missingChart').getContext('2d');
    const topMissing = missing.columns_with_missing.filter(col => col.missing_count > 0).slice(0, 15);

    if (topMissing.length === 0) {
        document.getElementById('missing-chart-container').innerHTML =
            '<div class="flash-msg success" style="justify-content:center;"><i class="fa-solid fa-circle-check"></i> No hay valores faltantes en ninguna columna</div>';
        return;
    }

    if (charts.missing) charts.missing.destroy();
    charts.missing = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topMissing.map(col => col.column),
            datasets: [{ label: 'Porcentaje Faltante', data: topMissing.map(col => col.missing_percentage), backgroundColor: '#ef4444', borderWidth: 0 }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
    });
}

function renderNumericStatsTable(numeric) {
    const table = document.getElementById('numeric-stats-table');
    if (!numeric.stats || numeric.stats.length === 0) {
        table.innerHTML = '<tr><td style="text-align:center;padding:24px;color:var(--c-text-secondary);">No hay columnas numericas</td></tr>';
        return;
    }
    let html = `<thead><tr><th>Columna</th><th>Conteo</th><th>Media</th><th>Mediana</th><th>Desv. Est.</th><th>Min</th><th>Max</th><th>Q25</th><th>Q75</th></tr></thead><tbody>`;
    numeric.stats.forEach(s => {
        html += `<tr><td><strong>${s.column}</strong></td><td>${s.count}</td><td>${s.mean}</td><td>${s.median}</td><td>${s.std}</td><td>${s.min}</td><td>${s.max}</td><td>${s.q25}</td><td>${s.q75}</td></tr>`;
    });
    html += '</tbody>';
    table.innerHTML = html;
}

function renderCorrelationMatrix(correlation) {
    const table = document.getElementById('correlation-table');
    const columns = correlation.columns;
    let html = '<thead><tr><th></th>';
    columns.forEach(c => { html += `<th>${c}</th>`; });
    html += '</tr></thead><tbody>';
    correlation.matrix.forEach(row => {
        html += `<tr><th>${row.column}</th>`;
        columns.forEach(c => {
            const v = row.correlations[c];
            html += `<td class="correlation-cell" style="background-color:${getCorrelationColor(v)}">${v}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    table.innerHTML = html;
}

function getCorrelationColor(value) {
    if (value > 0) {
        const i = Math.floor(255 - (value * 155));
        return `rgb(${i}, ${i}, 255)`;
    } else {
        const i = Math.floor(255 + (value * 155));
        return `rgb(255, ${i}, ${i})`;
    }
}

function renderDistributions(distributions) {
    const container = document.getElementById('distributions-container');
    container.innerHTML = '';
    distributions.forEach((dist, idx) => {
        const canvasId = `dist-chart-${idx}`;
        const div = document.createElement('div');
        div.className = 'chart-item';
        div.innerHTML = `<h4 style="text-align:center;margin-bottom:10px;">${dist.column}</h4><canvas id="${canvasId}"></canvas>`;
        container.appendChild(div);
        const ctx = document.getElementById(canvasId).getContext('2d');
        charts[`dist-${idx}`] = new Chart(ctx, {
            type: 'bar',
            data: { labels: dist.bins.map(b => b.toFixed(1)), datasets: [{ label: 'Frecuencia', data: dist.counts, backgroundColor: '#3f3fff', borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 45, minRotation: 45 } } } }
        });
    });
}

function renderCategoricalDistributions(distributions) {
    const container = document.getElementById('categorical-container');
    container.innerHTML = '';
    distributions.forEach((dist, idx) => {
        const canvasId = `cat-chart-${idx}`;
        const div = document.createElement('div');
        div.className = 'chart-item';
        div.innerHTML = `<h4 style="text-align:center;margin-bottom:10px;">${dist.column}</h4><canvas id="${canvasId}"></canvas>`;
        container.appendChild(div);
        const ctx = document.getElementById(canvasId).getContext('2d');
        charts[`cat-${idx}`] = new Chart(ctx, {
            type: 'bar',
            data: { labels: dist.labels, datasets: [{ label: 'Frecuencia', data: dist.counts, backgroundColor: '#22c55e', borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { ticks: { maxRotation: 45, minRotation: 45 } } } }
        });
    });
}

function resetForm() {
    document.getElementById('upload-card').style.display = 'block';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('btnAnalyze').disabled = false;
    document.getElementById('btnAnalyze').innerHTML = '<i class="fa-solid fa-bolt"></i> Analizar Archivo';
    fileInput.value = '';
    fileNameDisplay.innerText = 'No se ha seleccionado ningun archivo';
    Object.values(charts).forEach(c => { if (c && c.destroy) c.destroy(); });
    charts = {};
}
</script>
{% endblock %}
