{% extends 'base.html' %}
{% block title %}Usuarios | Admin{% endblock %}
{% block content %}
<div class="admin-container">
  <div class="admin-header">
    <h1>ğŸ‘¥ GestiÃ³n de Usuarios</h1>
    <a href="{{ url_for('admin.dashboard') }}" class="btn light">â† Panel</a>
  </div>

  <!-- Search & Filter -->
  <div class="admin-filters">
    <form method="GET" class="filter-form">
      <input type="text" name="q" placeholder="ğŸ” Buscar por nombre o email..." value="{{ search }}" class="filter-input">
      <select name="role" class="filter-select">
        <option value="">Todos los roles</option>
        <option value="admin" {{ 'selected' if role_filter == 'admin' }}>Admin</option>
        <option value="DI" {{ 'selected' if role_filter == 'DI' }}>DI</option>
        <option value="MW" {{ 'selected' if role_filter == 'MW' }}>MW</option>
      </select>
      <button type="submit" class="btn blue">Filtrar</button>
    </form>
    <a href="{{ url_for('admin.user_create') }}" class="btn blue">â• Nuevo Usuario</a>
  </div>

  <!-- Users Table -->
  {% if users %}
  <table class="admin-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Usuario</th>
        <th>Email</th>
        <th>Rol</th>
        <th>Estado</th>
        <th>Creado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr class="{{ 'inactive-row' if not user.is_active }}">
        <td>{{ user.id }}</td>
        <td><strong>{{ user.username }}</strong></td>
        <td>{{ user.email }}</td>
        <td><span class="role-badge role-{{ user.role }}">{{ user.role }}</span></td>
        <td>
          {% if user.is_active %}
            <span class="status-badge active">Activo</span>
          {% else %}
            <span class="status-badge inactive">Inactivo</span>
          {% endif %}
        </td>
        <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else 'â€”' }}</td>
        <td class="actions-cell">
          <a href="{{ url_for('admin.user_edit', user_id=user.id) }}" class="action-btn edit" title="Editar">âœï¸</a>
          <a href="{{ url_for('admin.user_activity', user_id=user.id) }}" class="action-btn log" title="Ver actividad">ğŸ“‹</a>
          {% if user.id != current_user.id %}
          <form method="POST" action="{{ url_for('admin.user_toggle', user_id=user.id) }}" style="display:inline;">
            <button type="submit" class="action-btn toggle" title="{{ 'Desactivar' if user.is_active else 'Activar' }}">
              {{ 'ğŸ”’' if user.is_active else 'ğŸ”“' }}
            </button>
          </form>
          <form method="POST" action="{{ url_for('admin.user_delete', user_id=user.id) }}" style="display:inline;"
                onsubmit="return confirm('Â¿Desactivar a {{ user.username }}?');">
            <button type="submit" class="action-btn delete" title="Eliminar">ğŸ—‘ï¸</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <p class="table-count">{{ users|length }} usuario(s) encontrado(s)</p>
  {% else %}
  <p class="empty-state">No se encontraron usuarios con los filtros aplicados.</p>
  {% endif %}
</div>
{% endblock %}
