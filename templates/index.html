<!-- templates/index.html -->
{% extends 'base.html' %}
{% block title %}Generar Reporte | Data Intel{% endblock %}
{% block page_name %}Generar Reporte{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Generar Reporte</h1>
  <p>Crea reportes de analisis automatizados desde archivos CSV.</p>
</div>

<div class="card">
  <form action="/upload_csv" method="POST" enctype="multipart/form-data" id="reportForm">

    <div class="form-group">
      <label class="form-label" for="template_name">Plantilla de reporte</label>
      <select id="template_name" name="template_name" class="form-select" required>
        {% if available_templates %}
          {% for tpl in available_templates %}
            <option value="{{ tpl }}" {% if tpl == default_template %}selected{% endif %}>{{ tpl }}</option>
          {% endfor %}
        {% else %}
          <option value="" disabled selected>No hay plantillas disponibles</option>
        {% endif %}
      </select>
      <label class="form-check" style="margin-top: 8px;">
        <input type="checkbox" name="fallback_default" checked />
        Usar plantilla predeterminada como respaldo
      </label>
    </div>

    <div class="form-group">
      <label class="form-label">Archivo CSV</label>
      <div class="upload-zone" id="drop-zone" onclick="document.getElementById('csv_file').click()">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <div class="upload-zone-title">Haz clic o arrastra un archivo</div>
        <div class="upload-zone-hint" id="file-name-display">Selecciona un archivo CSV para generar el reporte</div>
        <input type="file" id="csv_file" name="csv_file" accept=".csv" required style="display:none;" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="report_title">Nombre del reporte</label>
        <input type="text" id="report_title" name="report_title" class="form-input" placeholder="Ej: Reporte Mensual Cliente X" />
      </div>
      <div class="form-group">
        <label class="form-label" for="wordcloud_file">Wordcloud (opcional)</label>
        <input type="file" id="wordcloud_file" name="wordcloud_file" accept="image/png" class="form-input" style="padding: 8px;" />
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="description">Descripcion</label>
      <textarea id="description" name="description" class="form-textarea" placeholder="Describe brevemente el contenido del reporte"></textarea>
    </div>

    <label class="form-check" style="margin-bottom: 20px;">
      <input type="checkbox" name="solo_fecha" />
      Solo fecha (sin hora)
    </label>

    <button type="submit" class="btn btn-primary btn-block btn-lg" id="btnSubmit">
      <i class="fa-solid fa-file-powerpoint"></i> Generar reporte
    </button>

    <div id="mensaje-cargando" class="flash-msg info" style="display: none; margin-top: 16px;">
      <i class="fa-solid fa-spinner fa-spin"></i> Procesando reporte... Esto puede tardar unos segundos.
    </div>
  </form>
</div>

<script>
  // File input display
  const csvInput = document.getElementById('csv_file');
  const fileDisplay = document.getElementById('file-name-display');
  const dropZone = document.getElementById('drop-zone');

  csvInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      fileDisplay.textContent = e.target.files[0].name;
      dropZone.style.borderColor = 'var(--c-primary)';
    }
  });

  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', function() {
    this.classList.remove('dragover');
  });
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      csvInput.files = e.dataTransfer.files;
      fileDisplay.textContent = e.dataTransfer.files[0].name;
      dropZone.style.borderColor = 'var(--c-primary)';
    }
  });

  // Loading state
  document.getElementById('reportForm').addEventListener('submit', function() {
    document.getElementById('mensaje-cargando').style.display = 'flex';
    document.getElementById('btnSubmit').disabled = true;
    document.getElementById('btnSubmit').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';
  });
</script>
{% endblock %}