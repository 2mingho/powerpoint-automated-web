{% extends 'base.html' %}
{% block title %}Generar Reporte | Data Intel{% endblock %}

{% block content %}
  
  <h1 class="page-title">Nuevo Reporte</h1>
  <p class="page-subtitle">Sube tu CSV para generar análisis automáticos y presentaciones.</p>

  <div class="card-container">
    <form action="/" method="POST" enctype="multipart/form-data" onsubmit="mostrarCargando()">
      
      <div class="form-group">
        <label for="template_name">Plantilla</label>
        <select id="template_name" name="template_name" required>
          {% if available_templates %}
            {% for tpl in available_templates %}
              <option value="{{ tpl }}" {% if tpl == default_template %}selected{% endif %}>{{ tpl }}</option>
            {% endfor %}
          {% else %}
            <option value="" disabled selected>No hay plantillas disponibles</option>
          {% endif %}
        </select>
        
        <div class="checkbox-group">
          <input type="checkbox" id="fallback_default" name="fallback_default" checked />
          <label for="fallback_default">Usar plantilla por defecto si falla</label>
        </div>
      </div>

      <div class="form-group">
        <label>Archivo de Datos (CSV)</label>
        <div class="upload-area">
          <input type="file" name="csv_file" accept=".csv" required onchange="actualizarNombreArchivo(this)" />
          <div class="upload-icon">☁️</div>
          <div class="upload-text">
            <strong id="file-label">Haz clic o arrastra tu archivo aquí</strong>
            <span>Soporta archivos .CSV (UTF-16)</span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="report_title">Título del Reporte</label>
        <input type="text" id="report_title" name="report_title" placeholder="Ej: Análisis Mensual Octubre" />
      </div>

      <div class="form-group">
        <label for="description">Descripción (Opcional)</label>
        <textarea id="description" name="description" placeholder="Notas adicionales para la diapositiva de introducción..."></textarea>
      </div>

      <div class="form-group" style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <label for="wordcloud_file">Wordcloud (Imagen PNG)</label>
            <input type="file" id="wordcloud_file" name="wordcloud_file" accept="image/png" style="padding: 8px;" />
        </div>
      </div>

      <div class="checkbox-group" style="margin-bottom: 20px;">
        <input type="checkbox" id="solo_fecha" name="solo_fecha" />
        <label for="solo_fecha">Mostrar solo fecha (sin hora)</label>
      </div>

      <button type="submit" class="btn-submit">✨ Generar Presentación</button>

      <p id="mensaje-cargando" style="display: none; text-align: center; color: var(--text-muted); margin-top: 15px; font-size: 0.9rem;">
        <span style="display:inline-block; animation: spin 1s infinite;">⏳</span> Procesando datos...
      </p>
    </form>
  </div>

  <script>
    function mostrarCargando() {
      const btn = document.querySelector('.btn-submit');
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.innerText = 'Procesando...';
      document.getElementById('mensaje-cargando').style.display = 'block';
    }

    function actualizarNombreArchivo(input) {
      const label = document.getElementById('file-label');
      if (input.files && input.files.length > 0) {
        label.innerText = "✅ " + input.files[0].name;
        label.style.color = 'var(--primary)';
      } else {
        label.innerText = "Haz clic o arrastra tu archivo aquí";
        label.style.color = 'inherit';
      }
    }
  </script>
{% endblock %}